<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fallout 76 Legendary Modules Manager v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #32cd32; /* Lime Green */
            --background-color: #1a202c; /* Dark Blue-Gray */
            --font-family: 'Press Start 2P', cursive;
            --border-color: var(--primary-color);
            --text-color: var(--primary-color);
            --text-secondary-color: #a0aec0; /* Lighter gray for less emphasis */
            --header-text-shadow: 0 0 10px var(--primary-color);
            --container-shadow: 0 0 20px var(--primary-color);
            --button-bg: rgba(50, 205, 50, 0.2);
            --button-hover-bg: rgba(50, 205, 50, 0.4);
            --button-active-bg: var(--primary-color);
            --button-active-color: var(--background-color);
            --button-action-color: #63b3ed; /* Blue for actions like edit */
            --button-action-hover-bg: rgba(99, 179, 237, 0.3);
            --button-danger-color: #f56565; /* Red for danger actions like delete */
            --button-danger-hover-bg: rgba(245, 101, 101, 0.3);
            --sidebar-shadow: 5px 0 10px rgba(50, 205, 50, 0.3);
            --table-header-bg: var(--primary-color);
            --table-header-color: var(--background-color);
            --table-row-even-bg: rgba(50, 205, 50, 0.05);
            --modal-overlay-bg: rgba(0, 0, 0, 0.8);
            --modal-bg: var(--background-color);
            --mobile-card-bg: rgba(50, 205, 50, 0.08);
            --mobile-label-color: rgba(50, 205, 50, 0.8);
            --mobile-separator-color: rgba(50, 205, 50, 0.3);
            --reset-button-color: #ecc94b; /* Yellow for reset */
            --reset-button-border: #ecc94b;
            --reset-button-bg: rgba(236, 201, 75, 0.15);
            --reset-button-hover-bg: rgba(236, 201, 75, 0.3);
            --reset-button-hover-shadow: 0 0 8px var(--reset-button-color);
            --input-bg: var(--background-color);
            --input-border: var(--border-color);
            --input-text: var(--text-color);
            --scrollbar-bg: #2d3748;
            --scrollbar-thumb-bg: var(--primary-color);
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 0px;
            --actions-column-width: 70px;
            --notification-bg: var(--background-color);
            --notification-success-border: var(--primary-color);
            --notification-error-border: var(--button-danger-color);
            --highlight-bg: rgba(236, 201, 75, 0.3);
            --scroll-arrow-bg: rgba(50, 205, 50, 0.5);
            --scroll-arrow-hover-bg: rgba(50, 205, 50, 0.8);
            --scroll-arrow-color: var(--background-color);
        }

        *, *::before, *::after { box-sizing: border-box; }

        /* Hide Default Scrollbars */
        .hide-scrollbar::-webkit-scrollbar { display: none; /* WebKit */ }
        .hide-scrollbar { -ms-overflow-style: none; /* IE and Edge */ scrollbar-width: none; /* Firefox */ }

        body {
            background-color: var(--background-color); color: var(--text-color); font-family: var(--font-family);
            margin: 0; padding: 0; display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; overflow-x: hidden; position: relative; font-size: 14px; line-height: 1.5;
        }
        body::before { /* Scanline effect */
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(18, 16, 16, 0.1) 50%, rgba(0, 0, 0, 0.2) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 1000;
        }
        .pipboy-container {
            display: flex; width: calc(100% - 40px); /* Auto width with margin */ max-width: 1900px; /* Max cap */ margin: 20px;
            border: 5px solid var(--border-color); box-shadow: var(--container-shadow); border-radius: 10px;
            background-color: var(--background-color); overflow: hidden; position: relative;
        }
        /* --- Sidebar --- */
        .pipboy-sidebar {
            width: var(--sidebar-width); flex-shrink: 0; border-right: 3px solid var(--border-color); padding: 0; /* Padding handled by wrapper */
            box-shadow: var(--sidebar-shadow); overflow: hidden; max-height: calc(100vh - 50px);
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out, border 0.3s ease-in-out;
            position: relative; display: flex; flex-direction: column;
        }
        .pipboy-sidebar.sidebar-collapsed { width: var(--sidebar-collapsed-width); border-right-width: 0; }
        .sidebar-content-wrapper {
            flex-grow: 1; overflow-y: auto; /* Still needs overflow for calculation */
            transition: opacity 0.2s ease-in-out; padding: 20px; /* Inner padding */
            position: relative; /* For scroll arrows */
        }
        .sidebar-collapsed .sidebar-content-wrapper { opacity: 0; pointer-events: none; }

        .pipboy-sidebar h2 { font-size: 1.3em; margin-bottom: 20px; text-shadow: 0 0 8px var(--primary-color); text-align: center; }
        .sidebar-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px dashed var(--border-color); }
        .sidebar-section:last-of-type { border-bottom: none; padding-bottom: 0; }

        .sidebar-button {
            display: block; width: 100%; padding: 10px; margin-bottom: 10px; background-color: var(--button-bg);
            color: var(--text-color); border: 1px solid var(--border-color); text-align: center; font-family: var(--font-family);
            cursor: pointer; transition: background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease; border-radius: 5px; font-size: 0.9em;
        }
        .sidebar-button:hover { background-color: var(--button-hover-bg); box-shadow: 0 0 8px var(--primary-color); }
        .sidebar-button.active { background-color: var(--button-active-bg); color: var(--button-active-color); box-shadow: 0 0 15px var(--primary-color); }
        .sidebar-button.reset-button { background-color: var(--reset-button-bg); border-color: var(--reset-button-border); color: var(--reset-button-color); }
        .sidebar-button.reset-button:hover { background-color: var(--reset-button-hover-bg); box-shadow: var(--reset-button-hover-shadow); }
        .sidebar-button.io-button { background-color: rgba(108, 99, 255, 0.15); border-color: #6c63ff; color: #a39fff; }
        .sidebar-button.io-button:hover { background-color: rgba(108, 99, 255, 0.3); box-shadow: 0 0 8px #6c63ff; }

        .settings-label { display: block; margin-bottom: 10px; font-size: 0.9em; text-align: center; margin-top: 15px; }
        .settings-control input[type="range"], .settings-control input[type="checkbox"] { width: 100%; accent-color: var(--primary-color); cursor: pointer; }
        .settings-control { margin-bottom: 15px; }
        .settings-control label { display: flex; align-items: center; font-size: 0.8em; margin-bottom: 5px; cursor: pointer; }
        .settings-control input[type="checkbox"] { width: auto; margin-right: 8px; transform: scale(1.1); }
        .width-value { font-size: 0.8em; margin-left: 5px; color: var(--text-secondary-color); }
        .mobile-close-button { display: none; position: absolute; top: 10px; right: 15px; background: rgba(50, 205, 50, 0.3); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 50%; width: 30px; height: 30px; font-size: 1.2em; line-height: 28px; text-align: center; cursor: pointer; font-family: sans-serif; z-index: 1150; }
        .mobile-close-button:hover { background-color: rgba(50, 205, 50, 0.6); }

        #desktop-sidebar-toggle {
            display: none; position: absolute; top: 50%; left: var(--sidebar-width); transform: translateY(-50%);
            width: 25px; height: 60px; background-color: var(--background-color); border: 2px solid var(--border-color);
            border-left: none; border-top-right-radius: 8px; border-bottom-right-radius: 8px; color: var(--text-color);
            cursor: pointer; z-index: 100; text-align: center; line-height: 56px; font-size: 1.2em;
            transition: left 0.3s ease-in-out, background-color 0.2s ease, color 0.2s ease, border-radius 0.3s ease-in-out, border 0.3s ease-in-out;
        }
        #desktop-sidebar-toggle:hover { background-color: var(--primary-color); color: var(--background-color); }
        .sidebar-collapsed + #desktop-sidebar-toggle { /* Use adjacent sibling selector */
            left: var(--sidebar-collapsed-width); border-left: 2px solid var(--border-color); border-right: none;
            border-radius: 0; border-top-left-radius: 8px; border-bottom-left-radius: 8px;
        }

        .search-input { width: 100%; padding: 8px; background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--input-text); font-family: var(--font-family); border-radius: 3px; font-size: 0.8em; margin-bottom: 15px; }
        .stats-display { font-size: 0.8em; color: var(--text-secondary-color); text-align: center; margin-top: 10px; line-height: 1.4; }
        .stats-display strong { color: var(--text-color); }

        /* --- Main Content --- */
        .pipboy-content { flex-grow: 1; padding: 0; /* Padding handled by wrapper */ overflow: hidden; /* Hide overflow, scroll handled by wrapper */ max-height: calc(100vh - 50px); position: relative; /* For scroll arrows */ }
        .pipboy-content-wrapper { height: 100%; overflow-y: auto; padding: 20px; } /* Inner scrollable wrapper */
        .pipboy-header { text-align: center; margin-bottom: 20px; font-size: 1.8em; text-shadow: var(--header-text-shadow); }

        /* --- Table Styles (Desktop) --- */
        .module-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; table-layout: fixed; }
        .module-table thead { display: table-header-group; }
        .module-table tbody { display: table-row-group; }
        .module-table tr { display: table-row; }
        .module-table th, .module-table td { display: table-cell; border: 1px solid var(--border-color); padding: 10px; text-align: left; vertical-align: top; overflow-wrap: break-word; }
        .module-table th { background-color: var(--table-header-bg); color: var(--table-header-color); font-weight: bold; text-shadow: none; position: relative; }
        .module-table th.sortable { cursor: pointer; }
        .module-table th.sortable:hover { background-color: var(--button-hover-bg); }
        .sort-indicator { margin-left: 5px; font-size: 0.8em; }
        .module-table th:first-child, .module-table td:first-child { width: 60px; text-align: center; vertical-align: middle; } /* Learned */
        .module-table th:last-child, .module-table td:last-child { width: var(--actions-column-width); text-align: center; vertical-align: middle; padding: 5px; } /* Actions */
        .module-table th:first-child, .module-table th:last-child { cursor: default; }
        .module-table th:first-child:hover, .module-table th:last-child:hover { background-color: var(--table-header-bg); }

        .module-table td.effect-cell { white-space: pre-line; }
        .module-table tbody tr:nth-child(even) { background-color: var(--table-row-even-bg); }
        .learned-checkbox { accent-color: var(--primary-color); transform: scale(1.2); cursor: pointer; }
        .no-modules-message { text-align: center; padding: 20px; font-size: 1.1em; color: var(--text-secondary-color); }
        .module-actions { display: flex; gap: 8px; justify-content: center; align-items: center; }
        .action-button { background: none; border: none; border-radius: 3px; cursor: pointer; padding: 4px; font-size: 1.1em; line-height: 1; transition: color 0.2s ease, transform 0.2s ease; }
        .action-button:hover { transform: scale(1.15); }
        .edit-button { color: var(--button-action-color); }
        .delete-button { color: var(--button-danger-color); }
        /* Hide card elements on desktop */
        .card-header, .card-body { display: none; }
        mark { background-color: var(--highlight-bg); color: inherit; padding: 0 1px; }


        /* --- Add Module Form --- */
        .module-form-section { margin-top: 30px; padding-top: 20px; border-top: 2px dashed var(--border-color); }
        .module-form-section h3 { font-size: 1.2em; margin-bottom: 15px; text-shadow: 0 0 8px var(--primary-color); }
        .module-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .module-form label { display: block; margin-bottom: 5px; font-size: 0.9em; }
        .module-form input, .module-form select { width: 100%; padding: 8px; background-color: var(--input-bg); border: 1px solid var(--input-border); color: var(--input-text); font-family: var(--font-family); box-sizing: border-box; border-radius: 3px; font-size: 0.9em; }
        .module-form input:disabled, .module-form select:disabled { opacity: 0.6; cursor: not-allowed; background-color: rgba(45, 55, 72, 0.5); }
        .module-form button { background-color: var(--primary-color); color: var(--button-active-color); padding: 10px 15px; border: none; cursor: pointer; font-family: var(--font-family); grid-column: 1 / -1; margin-top: 10px; transition: background-color 0.3s ease, box-shadow 0.3s ease; border-radius: 5px; font-size: 1em; }
        .module-form button:hover { background-color: var(--button-hover-bg); box-shadow: 0 0 10px rgba(50, 205, 50, 0.5); }
        .module-form button[type="button"] { background-color: var(--button-bg); color: var(--text-color); border: 1px solid var(--border-color); grid-column: auto; }
        .module-form button[type="button"]:hover { background-color: var(--button-hover-bg); }

        /* --- Modal Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg); z-index: 1200; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 15px; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--modal-bg); color: var(--text-color); padding: 30px; border-radius: 10px; border: 3px solid var(--border-color); box-shadow: var(--container-shadow); max-width: 90%; width: 550px; position: relative; transform: scale(0.9); transition: transform 0.3s ease; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { flex-shrink: 0; }
        .modal-body { flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-bottom: 15px; }
        .modal-footer { flex-shrink: 0; padding-top: 15px; }
        .modal-close-button { position: absolute; top: 10px; right: 10px; background: none; border: none; color: var(--text-color); font-size: 1.8em; cursor: pointer; line-height: 1; padding: 5px; font-family: sans-serif; }
        .modal-close-button:hover { color: var(--button-danger-color); }
        .modal-content h3 { text-align: center; margin-bottom: 20px; font-size: 1.1em; text-shadow: 0 0 8px var(--primary-color); }
        .modal-form .module-form-buttons { display: flex; justify-content: flex-end; gap: 10px; grid-column: 1 / -1; margin-top: 15px; }
        .modal-form button { grid-column: auto; margin-top: 0; }

        /* --- Notification Styles --- */
        .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); /* Start hidden below */ background-color: var(--notification-bg); color: var(--text-color); padding: 12px 20px; border-radius: 5px; border: 2px solid var(--notification-success-border); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); z-index: 1300; font-size: 0.9em; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease; }
        .notification.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
        .notification.error { border-color: var(--notification-error-border); color: var(--button-danger-color); }
        .notification.success { border-color: var(--notification-success-border); color: var(--primary-color); }

        /* --- Custom Scroll Arrows --- */
        .scroll-arrow {
            position: absolute; left: 50%; transform: translateX(-50%);
            width: 30px; height: 20px; background-color: var(--scroll-arrow-bg);
            color: var(--scroll-arrow-color); border: 1px solid var(--border-color);
            border-radius: 4px; cursor: pointer; z-index: 100;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8em; line-height: 1; opacity: 0.7;
            transition: opacity 0.2s ease, background-color 0.2s ease;
        }
        .scroll-arrow:hover { opacity: 1; background-color: var(--scroll-arrow-hover-bg); }
        .scroll-arrow-up { top: 5px; border-bottom: none; border-radius: 4px 4px 0 0; }
        .scroll-arrow-down { bottom: 5px; border-top: none; border-radius: 0 0 4px 4px; }
        .scroll-arrow.hidden { opacity: 0; pointer-events: none; }


        /* --- Mobile Specific --- */
        #mobile-settings-button { display: none; position: fixed; bottom: 20px; right: 20px; background-color: rgba(50, 205, 50, 0.8); color: var(--button-active-color); border: 2px solid var(--border-color); border-radius: 50%; width: 50px; height: 50px; font-size: 1.8em; line-height: 50px; text-align: center; cursor: pointer; z-index: 1050; box-shadow: 0 0 15px rgba(50, 205, 50, 0.5); }
        #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--mobile-overlay-bg); z-index: 1090; }
        #file-import-input { display: none; }

        /* --- Desktop-Only Styles (> 768px) --- */
        @media (min-width: 769px) {
             #desktop-sidebar-toggle { display: block; }
        }

        /* --- Mobile Styles (<= 768px) --- */
        @media (max-width: 768px) {
            body { overflow-x: hidden; font-size: 13px; }
            .pipboy-container { flex-direction: column; margin: 0; border: none; box-shadow: none; border-radius: 0; max-width: 100%; }
            /* Mobile Sidebar (Slide-in) */
            .pipboy-sidebar {
                position: fixed; top: 0; left: 0; width: 85%; max-width: 300px; height: 100%; max-height: 100%;
                border-right: 3px solid var(--border-color); background-color: var(--background-color); z-index: 1100;
                transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5); padding-top: 50px;
                 transition: transform 0.3s ease-in-out;
            }
            .pipboy-sidebar.sidebar-collapsed { width: 85%; padding: 0; border-right-width: 3px; transform: translateX(-100%); } /* Padding handled by wrapper */
            .sidebar-content-wrapper { padding: 20px; padding-top: 0; } /* Adjust padding */
            .sidebar-collapsed .sidebar-content-wrapper { opacity: 1; pointer-events: auto; }

            .pipboy-sidebar.mobile-sidebar-open { transform: translateX(0); }
            .pipboy-sidebar.mobile-sidebar-open .mobile-close-button { display: block; }

            .pipboy-content { padding: 0; max-height: none; overflow: hidden; width: 100%; } /* Overflow handled by wrapper */
            .pipboy-content-wrapper { padding: 10px; height: calc(100vh - 50px); /* Adjust based on header/footer */ }
            .pipboy-header { font-size: 1.4em; margin-top: 10px; }

            /* Mobile Table (Card View) */
            .module-table { display: block; border: none; font-size: 0.85em; margin-top: 10px; }
            .module-table thead { display: none; }
            .module-table tbody { display: block; width: 100%; }
            .module-table tr { /* Card Styling */
                display: block; border: 2px solid var(--border-color); border-radius: 8px;
                margin-bottom: 15px; padding: 0; background-color: var(--mobile-card-bg);
                box-shadow: 0 2px 5px rgba(0,0,0,0.2); position: relative;
            }
             /* Hide desktop TDs, show card elements */
            .module-table tr > td { display: none !important; }
            .card-header, .card-body { display: block; }

            .card-header { display: flex; justify-content: center; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color); position: relative; }
            .learned-checkbox { transform: scale(1.5); }
            .module-actions { position: absolute; top: 8px; right: 8px; opacity: 1; }
            .card-body { padding: 8px 12px; }
            .card-body .data-row { display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0; border-bottom: 1px dashed var(--mobile-separator-color); text-align: right; width: 100%; overflow-wrap: break-word; word-break: break-word; line-height: 1.4; }
            .card-body .data-row:last-child { border-bottom: none; }
            .card-body .data-row::before { content: attr(data-label); font-weight: normal; text-align: left; margin-right: 15px; color: var(--mobile-label-color); flex-shrink: 0; font-size: 0.9em; padding-top: 1px; }
            .card-body .data-row > span { flex-grow: 1; word-break: break-word; }

            .add-module-form { grid-template-columns: 1fr; }
            .settings-label[for="containerWidth"], .settings-control input[type="range"]#containerWidth { display: none; }
            #mobile-settings-button { display: block; }
            #desktop-sidebar-toggle { display: none; }
            #sidebar-overlay.active { display: block; }
            .modal-content { width: 95%; padding: 20px; }
            .modal-form .module-form-buttons { justify-content: space-between; }
            .scroll-arrow { /* Adjust arrow position/size slightly for mobile */ width: 28px; height: 18px; font-size: 0.7em; }
            .scroll-arrow-up { top: 3px; }
            .scroll-arrow-down { bottom: 3px; }
        }

         @media (max-width: 480px) {
             body { font-size: 12px; }
             .pipboy-sidebar { width: 90%; padding-top: 45px; }
             .pipboy-sidebar.sidebar-collapsed { width: 90%; }
             .pipboy-sidebar h2 { font-size: 1.1em; }
             .sidebar-button { font-size: 0.8em; }
             .pipboy-header { font-size: 1.3em; }
             .module-table { font-size: 0.8em; }
             .module-table tr { margin-bottom: 12px; }
             .card-header { padding: 10px; }
             .card-body { padding: 6px 10px; }
             .card-body .data-row { padding: 6px 0; }
             .card-body .data-row::before { margin-right: 10px; font-size: 0.85em; }
             .learned-checkbox { transform: scale(1.4); }
             .add-module-section h3 { font-size: 1em; }
             .module-form label, .module-form input, .module-form select, .module-form button { font-size: 0.8em; }
             .settings-control label { font-size: 0.75em; }
             .width-value { font-size: 0.7em; }
             #mobile-settings-button { width: 45px; height: 45px; line-height: 45px; font-size: 1.6em; bottom: 15px; right: 15px; }
             .modal-content h3 { font-size: 1em; }
         }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef, memo, Fragment } = React;

    // --- Constants ---
    const LS_KEYS = { MODULES: 'fallout76Modules_v2', COLUMN_SETTINGS: 'fallout76ColumnSettings_v2' }; // Removed Container Width
    const DEBOUNCE_DELAY = { WIDTH: 250, SEARCH: 300 };
    const NOTIFICATION_TIMEOUT = 3000;
    const SCROLL_STEP = 50; // Pixels to scroll with arrows

    // --- Hooks ---
    function useDebounce(value, delay) { /* ... Omitted ... */
        const [debouncedValue, setDebouncedValue] = useState(value); useEffect(() => { const handler = setTimeout(() => { setDebouncedValue(value); }, delay); return () => { clearTimeout(handler); }; }, [value, delay]); return debouncedValue;
    }
    function useNotification() { /* ... Omitted ... */
        const [notification, setNotification] = useState({ message: '', type: '', show: false }); const timeoutRef = useRef(null); const showNotification = useCallback((message, type = 'success') => { if (timeoutRef.current) { clearTimeout(timeoutRef.current); } setNotification({ message, type, show: true }); timeoutRef.current = setTimeout(() => { setNotification(prev => ({ ...prev, show: false })); }, NOTIFICATION_TIMEOUT); }, []); const NotificationComponent = useMemo(() => { return ({ message, type, show }) => ( <div className={`notification ${type} ${show ? 'show' : ''}`} role="alert">{message}</div> ); }, []); return [notification, showNotification, NotificationComponent];
    }

    // --- Helper Functions ---
    const getStars = (count) => '⭐'.repeat(count);
    const formatEffectText = (text) => { /* ... Omitted ... */
        if (typeof text !== 'string') return ''; if (text.includes('[Оружие]') && text.includes('[Броня]')) return text.replace('[Броня]', '\n[Броня]'); return text;
    };
    const highlightText = (text, highlight) => { /* ... Omitted ... */
        if (!highlight || !text) return text; const regex = new RegExp(`(${highlight.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi'); const parts = text.split(regex); return parts.map((part, i) => regex.test(part) ? <mark key={i}>{part}</mark> : part );
    };

    // --- Initial Data & Config ---
    const initialModulesData = [ /* ... Omitted ... */
        { ruName: 'Антирадиационная', enName: 'DMGGhouls', stars: 1, effect: '[Оружие] +50% Урон гулям. [Броня]-15% Урон от гулей.', isCustom: false }, { ruName: 'Аристократическая', enName: 'ProportionalCaps', stars: 1, effect: '[Оружие] До +50% к урону в зависимости от количества имеющихся у вас крышек. [Броня] Повышение сопротивляемости обычному и энергетическому урону по мере увеличения количества крышек (до +20).', isCustom: false }, { ruName: 'Берсеркерское', enName: 'DamageUnarmored', stars: 1, effect: 'Пока снижается Сопр. урону, увеличивается урон, но не более чем на +50%.', isCustom: false }, { ruName: 'Вампирское', enName: 'Vampire', stars: 1, effect: 'Вы восстанавливаете 2% здоровья в течение 2 сек. после попадания по цели.', isCustom: false }, { ruName: 'Гибельная', enName: 'DMGBugs', stars: 1, effect: '[Оружие] +50% Урон насекомым. +50% Урон болотникам. [Броня] -15% Урон от болотников и насекомых.', isCustom: false }, { ruName: 'Маскирующая', enName: 'CloakOnMelee', stars: 1, effect: 'Ранение в ближнем бою делает игрока невидимым раз в 30 секунд.', isCustom: false }, { ruName: 'Мутантная', enName: 'Mutation', stars: 1, effect: '[Оружие] При получении мутаций увеличивается урон, но не более чем на +25%. [Броня] +10 к сопротивляемости обычному и энергетическому урону при мутации.', isCustom: false }, { ruName: 'Мутантоистребительная', enName: 'DMGSuperMutants', stars: 1, effect: '[Оружие] +50% Урон супермутантам. [Броня] -15% Урон от супермутантов.', isCustom: false }, { ruName: 'Палаческое', enName: 'Execute', stars: 1, effect: 'На +50% больше урона, когда у вашей цели осталось меньше 40% здоровья.', isCustom: false }, { ruName: 'Регенерирующая', enName: 'HealthRegen', stars: 1, effect: '+0,5% темп лечения.', isCustom: false }, { ruName: 'Ремонтная', enName: 'DMGRobots', stars: 1, effect: '[Оружие] +50% Урон роботам. [Броня] -15% Урон от роботов.', isCustom: false }, { ruName: 'Убийственная', enName: 'DMGPlayers', stars: 1, effect: '[Оружие] +50% Урон людям. [Броня]-15% Урон от людей.', isCustom: false }, { ruName: 'Выносливость', enName: 'StatEndurance', stars: 2, effect: '+2 Выносливость.', isCustom: false }, { ruName: 'Ликвидаторское', enName: 'Guns_DmgSights', stars: 2, effect: '+25% к наносимому урону при прицеливании.', isCustom: false }, { ruName: 'Последний выстрел', enName: 'Guns_LastShot', stars: 2, effect: 'Последний патрон в магазине с вероятностью 25% наносит на +100% больше урона.', isCustom: false }, { ruName: 'Стремительное', enName: 'Speed', stars: 2, effect: '+25% Скорость оружия (дальнобойное оружие). +40% Скорость оружия (холодное оружие).', isCustom: false }, { ruName: 'Удача', enName: 'StatLuck', stars: 2, effect: '+2 Удача.', isCustom: false }, { ruName: 'Быстрое', enName: 'Guns_ReloadSpeed', stars: 3, effect: '+15% Скорость перезарядки.', isCustom: false }, { ruName: 'Восприятие', enName: 'StatPerception', stars: 3, effect: '+3 Восприятие.', isCustom: false }, { ruName: 'Выносливость', enName: 'StatEndurance', stars: 3, effect: '+3 Выносливость.', isCustom: false }, { ruName: 'Интеллект', enName: 'StatIntelligence', stars: 3, effect: '+3 Интеллект.', isCustom: false }, { ruName: 'Ловкое', enName: 'Guns_MoveSpeedSights', stars: 3, effect: '+100% увеличенная скорость передвижения при прицеливании.', isCustom: false }, { ruName: 'Оптимизированное V.A.T.S.', enName: 'VATSCostAP', stars: 3, effect: '-25% Расход очков действия.', isCustom: false }, { ruName: 'Трюковая', enName: 'LessFallDamage', stars: 3, effect: '-50% урон от падения.', isCustom: false }, { ruName: 'Ядовитая', enName: 'Toxic', stars: 3, effect: '5%-ный шанс нанести 12 единиц урона ядом в ближнем бою в течение 7 секунд.', isCustom: false }, { ruName: 'Спасательная', enName: 'AutoRevive', stars: 1, effect: 'Погибая, вы сможете раз в минуту оживлять себя с помощью стимулятора с вероятностью 50%.', isCustom: false }, { ruName: 'Хамелеон', enName: 'Chameleon', stars: 1, effect: 'Сливайтесь с окружением в режиме скрытного передвижения и стоя на месте.', isCustom: false }, { ruName: 'Стойкая', enName: 'LowHealthIncreasesStats', stars: 1, effect: 'Прибавка до +3 ко всем параметрам S.P.E.C.I.A.L. (кроме выносливости) при низком уровне здоровья.', isCustom: false }, { ruName: 'Стимуляторная', enName: 'LowHealthTriggersStimpak', stars: 1, effect: 'Автоматическое применение стимулятора при падении здоровья до 25% или ниже 60.', isCustom: false }, { ruName: 'Лакомки', enName: 'Overeater', stars: 1, effect: 'Снижает получаемый урон до +6% по мере заполнения шкал голода и жажды.', isCustom: false }, { ruName: 'Подкрепляющая', enName: 'ResistancesInverseHealth', stars: 1, effect: 'Повышение сопротивляемости обычному и энергетическому урону по мере уменьшения здоровья (до +35).', isCustom: false }, { ruName: 'Авангардная', enName: 'ResistancesProportionalHealth', stars: 1, effect: 'Повышение сопротивляемости обычному и энергетическому урону по мере увеличения здоровья (до +35).', isCustom: false }, { ruName: 'Невесомая', enName: 'Weightless', stars: 1, effect: '-90% Вес.', isCustom: false }, { ruName: 'Пронзительная', enName: 'AntiArmor', stars: 1, effect: '+50% Бронебойность.', isCustom: false }, { ruName: 'Наркоманское', enName: 'DamageAddiction', stars: 1, effect: 'Урон увеличивается за каждую зависимость, но не более чем на +50%.', isCustom: false }, { ruName: 'Провоцирующее', enName: 'DamageFirstBlood', stars: 1, effect: '+100% к урону целям при полном здоровье.', isCustom: false }, { ruName: 'Окровавленное', enName: 'DamageInverseHealth', stars: 1, effect: 'При снижении уровня здоровья увеличивается урон, но не более чем на +95%.', isCustom: false }, { ruName: 'Гиганта', enName: 'DamageViaHealth', stars: 1, effect: 'При увеличении уровня здоровья увеличивается урон, но не более чем на +25%.', isCustom: false }, { ruName: 'Глушительное', enName: 'DebuffDamage', stars: 1, effect: 'Наносимый целью урон будет снижен на 25% в течение 5 секунд после вашей атаки.', isCustom: false }, { ruName: 'Яростное', enName: 'DmgConsecutiveHits', stars: 1, effect: '+5% к урону с каждой последующей атакой одной и той же цели, но не более +45%.', isCustom: false }, { ruName: 'Гурманское', enName: 'Gourmand', stars: 1, effect: 'По мере заполнения шкал голода и жажды урон увеличивается вплоть до +24%.', isCustom: false }, { ruName: 'Следопытское', enName: 'Guns_AccuracyNotInCombat', stars: 1, effect: '+100% к точности в V.A.T.S. по цене +50% очков действия, если вы не в бою.', isCustom: false }, { ruName: 'Четверное', enName: 'Guns_AmmoCapacity4x', stars: 1, effect: '+300% Боезапас.', isCustom: false }, { ruName: 'Двуствольное', enName: 'Guns_TwoShot', stars: 1, effect: '+1 Снаряды +25% Урон -150% точность стрельбы от бедра +100% Отдача.', isCustom: false }, { ruName: 'Медицинское', enName: 'Medic', stars: 1, effect: 'Атаки восстанавливают 5% здоровья вашим соратникам.', isCustom: false }, { ruName: 'Охотничья', enName: 'DMGAnimals', stars: 1, effect: '[Оружие] +50% Урон животным. [Броня] -15% Урон от животных.', isCustom: false }, { ruName: 'Фанатическая', enName: 'DMGScorched', stars: 1, effect: '[Оружие] +50% Урон горелым. [Броня] -15% Урон от горелых.', isCustom: false }, { ruName: 'Ночная', enName: 'Night', stars: 1, effect: '[Оружие] +50% к урону в ночное время. [Броня] +40 к сопротивляемости обычному и энергетическому урону по ночам.', isCustom: false }, { ruName: 'Силовая', enName: 'APRegen', stars: 2, effect: '+5% восстановлению очков действия.', isCustom: false }, { ruName: 'Нагревающая', enName: 'CryoResistance', stars: 2, effect: '+25 сопротивляемость холоду.', isCustom: false }, { ruName: 'Антисептик', enName: 'DiseaseResistance', stars: 2, effect: '+25% вероятность заболеть от окружающей среды.', isCustom: false }, { ruName: 'Огнеупорная', enName: 'Fireproof', stars: 2, effect: '+25 к сопротивлению огню.', isCustom: false }, { ruName: 'Обжоры', enName: 'Glutton', stars: 2, effect: 'Уровни голода и жажды растут на 10% медленнее.', isCustom: false }, { ruName: 'Знахарская', enName: 'PoisonResistance', stars: 2, effect: '+25 сопротивляемость ядам.', isCustom: false }, { ruName: 'Защита', enName: 'RadResistance', stars: 2, effect: '+25 сопротивляемость радиации.', isCustom: false }, { ruName: 'Живучесть', enName: 'ReduceExploisionDamage', stars: 2, effect: 'Снижает урон от взрывов на 7%.', isCustom: false }, { ruName: 'Инерционное', enName: 'APViaKill', stars: 2, effect: 'Восстанавливает 15 ОД при каждом убийстве.', isCustom: false }, { ruName: 'Актуальное', enName: 'DmgCrits', stars: 2, effect: '+50% Критический урон.', isCustom: false }, { ruName: 'Калечащее', enName: 'DmgLimbs', stars: 2, effect: '+50% Урон конечностям.', isCustom: false }, { ruName: 'Хрясь!', enName: 'Guns_Bashing', stars: 2, effect: '+50% Урон в ближнем бою.', isCustom: false }, { ruName: 'Взрывное', enName: 'Guns_ExplosiveBullets', stars: 2, effect: 'Снаряды взрываются и увеличивают урон от оружия на 20%.', isCustom: false }, { ruName: 'С улучшенным V.A.T.S.', enName: 'Guns_VATSAccuracy', stars: 2, effect: '+50% Шанс поразить цель в V.A.T.S.', isCustom: false }, { ruName: 'Парирующее', enName: 'Melee_BlockReflects', stars: 2, effect: '+50% отражения урона в ближнем бою при блокировании.', isCustom: false }, { ruName: 'Тяжёлое', enName: 'Melee_DamagePowerAttack', stars: 2, effect: '+40% Урон от мощных атак.', isCustom: false }, { ruName: 'Стойкое', enName: 'Melee_Steady', stars: 2, effect: '+25% к урону в ближнем бою, пока вы не двигаетесь.', isCustom: false }, { ruName: 'Ловкость', enName: 'StatAgility', stars: 2, effect: '+2 Ловкость.', isCustom: false }, { ruName: 'Харизма', enName: 'StatCharisma', stars: 2, effect: '+2 Харизма.', isCustom: false }, { ruName: 'Интеллект', enName: 'StatIntelligence', stars: 2, effect: '+2 Интеллект.', isCustom: false }, { ruName: 'Восприятие', enName: 'StatPerception', stars: 2, effect: '+2 Восприятие.', isCustom: false }, { ruName: 'Сила', enName: 'StatStrength', stars: 2, effect: '+2 Сила.', isCustom: false }, { ruName: 'Горящая', enName: 'Burning', stars: 3, effect: '5%-ный шанс нанести 19 единиц урона огнем.', isCustom: false }, { ruName: 'Прочность', enName: 'Durability', stars: 3, effect: '[Оружие] Оружие на 50% медленнее выходит из строя. [Броня] Вероятность поломки снижается на 50%.', isCustom: false }, { ruName: 'Электрифицированная', enName: 'Electrified', stars: 3, effect: '5%-ный шанс нанести 18 единиц энергетического урона в ближнем бою в течение 3 секунд.', isCustom: false }, { ruName: 'Ледяная', enName: 'Frozen', stars: 3, effect: '5%-ный шанс нанести 12 единиц урона холодом в ближнем бою в течение 4 секунд.', isCustom: false }, { ruName: 'Врачебная', enName: 'IncreaseHealing', stars: 3, effect: '+5% к эффективности стимуляторов, антирадина и Рад-Х.', isCustom: false }, { ruName: 'Защитная', enName: 'LessDamageStandStill', stars: 3, effect: '75% шанс снизить урон пока вы не двигаетесь.', isCustom: false }, { ruName: 'Воровская', enName: 'LockPick', stars: 3, effect: 'Увеличение размера зачетной зоны при взломе замков на 2.', isCustom: false }, { ruName: 'Рассеивающая', enName: 'RadsRegen', stars: 3, effect: '+0,25% Восстановление урона от радиации.', isCustom: false }, { ruName: 'Адамантиевая', enName: 'ReducedLimbDamage', stars: 3, effect: 'Снижает урон конечностям на 15%.', isCustom: false }, { ruName: 'Тайного агента', enName: 'Sneak', stars: 3, effect: '+25% Меньше шума при скрытном перемещении. +25% Уменьшить шанс обнаружения.', isCustom: false }, { ruName: 'Дайверская', enName: 'Waterbreathing', stars: 3, effect: 'Позволяет дышать под водой.', isCustom: false }, { ruName: 'С поясом', enName: 'WeightAmmo', stars: 3, effect: 'Боеприпасы весят на 20% меньше.', isCustom: false }, { ruName: 'Походная', enName: 'WeightFoodDrinkChems', stars: 3, effect: 'Еда, вода и препараты весят на 20% меньше.', isCustom: false }, { ruName: 'Барахольщицкая', enName: 'WeightJunk', stars: 3, effect: 'Хлам весит на 20% меньше.', isCustom: false }, { ruName: 'Хранителя оружия', enName: 'WeightWeapons', stars: 3, effect: 'Оружие весит на 20% меньше.', isCustom: false }, { ruName: 'Счастливое', enName: 'CritSpeed', stars: 3, effect: '+15 Бонус к критической атаке в V.A.T.S..', isCustom: false }, { ruName: 'Призрака', enName: 'Guns_CloakOnHit', stars: 3, effect: 'При попадании в цель у игрока есть 10% шанс стать невидимым на 2 секунд.', isCustom: false }, { ruName: 'Безотказное', enName: 'Guns_ResistReload', stars: 3, effect: '+250 к сопротивляемости урону при перезарядке.', isCustom: false }, { ruName: 'Надёжное', enName: 'Guns_ResistSights', stars: 3, effect: '+50 к сопротивляемости урону при прицеливании.', isCustom: false }, { ruName: 'Легкая', enName: 'Lightweight', stars: 3, effect: '-90% Вес.', isCustom: false }, { ruName: 'Ловкость', enName: 'StatAgility', stars: 3, effect: '+3 Ловкость.', isCustom: false }, { ruName: 'Харизма', enName: 'StatCharisma', stars: 3, effect: '+3 Харизма.', isCustom: false }, { ruName: 'Удача', enName: 'StatLuck', stars: 3, effect: '+3 Удача.', isCustom: false }, { ruName: 'Сила', enName: 'StatStrength', stars: 3, effect: '+3 Сила.', isCustom: false }, { ruName: 'Гадючий', enName: 'Vipers', stars: 4, effect: 'Пока цель в бою отравлена, увеличивает наносимый урон на 50%.', isCustom: false }, { ruName: 'Пироманский', enName: 'Pyromaniac', stars: 4, effect: 'Пока цель в бою горит, увеличивает наносимый урон на 50%.', isCustom: false }, { ruName: 'Полированный', enName: 'Polished', stars: 4, effect: 'Чем лучше состояние используемого предмета (+100%), тем больше урона наносит оружие (до +60%).', isCustom: false }, { ruName: 'Колотушка', enName: 'Melee_Pounders', stars: 4, effect: '+10% к урону за каждый заряд «Натиска», +10 к макс, количеству зарядов.', isCustom: false }, { ruName: 'Хладнокровный', enName: 'Melee_Icemens', stars: 4, effect: 'При нанесении урона в V.A.T.S. замораживает цель, замедляя её.', isCustom: false }, { ruName: 'Фехтование', enName: 'Melee_Fencers', stars: 4, effect: '+12,5% к урону в ближнем бою. Ещё +12,5% за каждого соратника, находящегося рядом (до +50% в полной команде).', isCustom: false }, { ruName: 'Сокрушающий', enName: 'Melee_ComboBreaker', stars: 4, effect: '50%-ный шанс не потратить очки действия при нанесении урона (10%-ный шанс для автоматического холодного оружия).', isCustom: false }, { ruName: 'Стабилизатор', enName: 'Guns_Stabilizers', stars: 4, effect: 'Улучшает отдачу и стабильность оружия на 50%.', isCustom: false }, { ruName: 'Филигранность', enName: 'Guns_PinPointers', stars: 4, effect: '+50% к урону вражеским конечностям (рукам, ногам и др.).', isCustom: false }, { ruName: 'Электротехнический', enName: 'Guns_Electricians', stars: 4, effect: 'При перезарядке создаёт ударную волну, которая оглушает находящиеся рядом цели на 3 секунды.', isCustom: false }, { ruName: 'Костоломный', enName: 'Fracturers', stars: 4, effect: 'Покалеченные конечности взрываются и наносят до 50 единиц урона взрывом находящимся рядом целям.', isCustom: false }, { ruName: 'Жатва', enName: 'Encirclers', stars: 4, effect: '+10% к урону за каждую боевую цель рядом с вами, но не более +50%.', isCustom: false }, { ruName: 'Проводник', enName: 'Conductors', stars: 4, effect: 'Критические удары восстанавливают 5% здоровья и очков действия игроку и соратникам в радиусе 50 футов.', isCustom: false }, { ruName: 'Задиристый', enName: 'Bully', stars: 4, effect: 'При атаке без использования V.A.T.S. увеличивает урон при поражении мест на +50%.', isCustom: false }, { ruName: 'Стойкость', enName: 'Tanky', stars: 4, effect: 'Пока вы стоите неподвижно, +200 к сопротивляемости урону на 10 секунд (до +1000 при максимальной силе эффекта). Срабатывает не чаще чем раз в 20 секунд.', isCustom: false }, { ruName: 'Хирургия', enName: 'Sawbones', stars: 4, effect: 'Здоровье медленно восстанавливается (+1 единица в секунду, до +5 единиц в секунду при максимальной силе эффекта).', isCustom: false }, { ruName: 'Курьерский', enName: 'Runner', stars: 4, effect: 'Уменьшает расход очков действия при ускорении на 20% (до -100% при максимальной силе эффекта).', isCustom: false }, { ruName: 'Рейнджерский', enName: 'Ranger', stars: 4, effect: 'Увеличивает урон дальнобойного оружия на 5% (до +25% при максимальной силе эффекта).', isCustom: false }, { ruName: 'Зловонный', enName: 'Miasma', stars: 4, effect: 'При попадании создает ядовитое облако, которое наносит урон находящимся рядом целям в течении 10 секунд. Чем больше деталей брони надето, тем больше урон от яда.', isCustom: false }, { ruName: 'Неудержимость', enName: 'LimitBreak', stars: 4, effect: 'Каждая надетая деталь брони уменьшает стоимость критических атак на 10% (до -50% при максимальной силе эффекта).', isCustom: false }, { ruName: 'Боксерский', enName: 'Bruiser', stars: 4, effect: 'Увеличивает урон холодного оружия на 5% (до +25% при максимальной силе эффекта).', isCustom: false }, { ruName: 'Погрузочный', enName: 'BattleLoaders', stars: 4, effect: 'Удары прикладом по врагам мгновенно пополняют магазин вашего оружия с вероятностью 15% (до 75% при максимальной силе эффекта).', isCustom: false }, { ruName: 'Несгибаемость', enName: 'Stalwarts', stars: 4, effect: 'Запас прочности силовой брони игрока и всех соратников в радиусе 50 футов увеличивается на 5% (до 25% при максимальной силе эффекта).', isCustom: false }, { ruName: 'Сканирующий', enName: 'Scanners', stars: 4, effect: 'Уменьшает расход очков действия на атаки в V.A.T.S. на 5% (до -25% при максимальной силе эффекта).', isCustom: false }, { ruName: 'Обновление', enName: 'Rejuvenators', stars: 4, effect: 'Постепенно восстанавливает здоровье и очки владельца и соратников в радиусе 50 футов.', isCustom: false }, { ruName: 'Отражающий', enName: 'Reflective', stars: 4, effect: 'Возвращает 10% полученного урона врагу, который его нанёс (до 50% при максимальной силе эффекта).', isCustom: false }, { ruName: 'Ядерно-энергетический', enName: 'RadioactivePowered', stars: 4, effect: '+2 к восстанавлению очков действия за счёт радиации (до +10 при максимальной силе эффекта).', isCustom: false }, { ruName: 'Форсирующий', enName: 'Propelling', stars: 4, effect: 'Повышает скорость передвижения и ускорения на 5% (до +25% при максимальной силе эффекта).', isCustom: false }, { ruName: 'Чух-чух', enName: 'ChooChoo', stars: 4, effect: '10%-ный шанс нанести 500 единиц урона и активировать «Кровавую баню», когда вы врезаетесь в цель при ускорении (до 50% при максимальной силе эффекта).', isCustom: false }, { ruName: 'Укрывание', enName: 'Aegis', stars: 4, effect: 'Усиливает на +50 сопротивляемость физическому и энергетическому урону и на +20 — сопротивляемость ядам, холоду и огню игрока и соратников в радиусе 50 футов.', isCustom: false },
    ];
    const userLearnedListOnInit = new Set([ /* ... Omitted for brevity ... */
        'Антирадиационная-1', 'Аристократическая-1', 'Берсеркерское-1', 'Вампирское-1', 'Гибельная-1', 'Маскирующая-1', 'Мутантная-1', 'Мутантоистребительная-1', 'Палаческое-1', 'Регенерирующая-1', 'Ремонтная-1', 'Убийственная-1', 'Выносливость-2', 'Ликвидаторское-2', 'Последний выстрел-2', 'Стремительное-2', 'Удача-2', 'Быстрое-3', 'Восприятие-3', 'Выносливость-3', 'Интеллект-3', 'Ловкое-3', 'Оптимизированное V.A.T.S.-3', 'Трюковая-3', 'Ядовитая-3'
    ]);
    const columnConfig = [ /* ... Omitted for brevity ... */
        { id: 'learned', label: '💡', defaultWidth: 60, isVisibilityToggleable: false, isWidthAdjustable: false, isSortable: true, type: 'boolean' }, { id: 'ruName', label: 'Русское Название', defaultWidth: 200, minWidth: 100, maxWidth: 400, isVisibilityToggleable: true, isWidthAdjustable: true, isSortable: true, type: 'string' }, { id: 'enName', label: 'Editor ID', defaultWidth: 200, minWidth: 100, maxWidth: 400, isVisibilityToggleable: true, isWidthAdjustable: true, isSortable: true, type: 'string' }, { id: 'stars', label: 'Звёзды', defaultWidth: 100, minWidth: 50, maxWidth: 200, isVisibilityToggleable: true, isWidthAdjustable: true, isSortable: true, type: 'number' }, { id: 'effect', label: 'Эффект', defaultWidth: 300, minWidth: 150, maxWidth: 600, isVisibilityToggleable: true, isWidthAdjustable: true, isSortable: true, type: 'string' }, { id: 'actions', label: 'Действие', defaultWidth: 70, isVisibilityToggleable: false, isWidthAdjustable: false, isSortable: false, type: 'actions' }
    ];
    const defaultColumnVisibility = columnConfig.reduce((acc, col) => { acc[col.id] = true; return acc; }, {});
    const defaultColumnWidths = columnConfig.reduce((acc, col) => { acc[col.id] = col.defaultWidth; return acc; }, {});
    const loadModules = () => { /* ... Omitted for brevity ... */
        const savedModulesJSON = localStorage.getItem(LS_KEYS.MODULES); let finalModules = []; const initialModulesMap = new Map(initialModulesData.map(m => [`${m.ruName}-${m.stars}`, { ...m, isCustom: false }])); if (savedModulesJSON) { try { const savedModules = JSON.parse(savedModulesJSON); if (Array.isArray(savedModules)) { const savedModulesMap = new Map(); savedModules.forEach(m => { if (m && typeof m.ruName === 'string' && typeof m.stars === 'number') savedModulesMap.set(`${m.ruName}-${m.stars}`, m); }); initialModulesMap.forEach((initialModule, key) => { const savedModule = savedModulesMap.get(key); if (savedModule) { finalModules.push({ ...initialModule, learned: typeof savedModule.learned === 'boolean' ? savedModule.learned : false, isCustom: savedModule.isCustom ?? false }); savedModulesMap.delete(key); } else { finalModules.push({ ...initialModule, learned: userLearnedListOnInit.has(key) }); } }); savedModulesMap.forEach(customModule => { finalModules.push({ ruName: customModule.ruName, enName: customModule.enName || '', stars: customModule.stars, effect: customModule.effect || '', learned: typeof customModule.learned === 'boolean' ? customModule.learned : false, isCustom: true }); }); } else { throw new Error("Saved data is not an array."); } } catch (e) { console.error("Failed to load or parse modules:", e); finalModules = initialModulesData.map(module => ({ ...module, learned: userLearnedListOnInit.has(`${module.ruName}-${module.stars}`) })); } } else { finalModules = initialModulesData.map(module => ({ ...module, learned: userLearnedListOnInit.has(`${module.ruName}-${module.stars}`) })); } return finalModules;
    };
    const saveModules = (modules) => { /* ... Omitted for brevity ... */
         const dataToSave = modules.map(({ ruName, stars, learned, enName, effect, isCustom }) => ({ ruName, stars, learned, enName: enName || '', effect: effect || '', isCustom })); localStorage.setItem(LS_KEYS.MODULES, JSON.stringify(dataToSave));
    };
    const loadColumnSettings = () => { /* ... Omitted for brevity ... */
        const savedSettingsJSON = localStorage.getItem(LS_KEYS.COLUMN_SETTINGS); if (savedSettingsJSON) { try { const savedSettings = JSON.parse(savedSettingsJSON); const visibility = { ...defaultColumnVisibility }; const widths = { ...defaultColumnWidths }; columnConfig.forEach(col => { if (col.isVisibilityToggleable && typeof savedSettings?.visibility?.[col.id] === 'boolean') visibility[col.id] = savedSettings.visibility[col.id]; else if (!col.isVisibilityToggleable) visibility[col.id] = true; if (col.isWidthAdjustable && typeof savedSettings?.widths?.[col.id] === 'number') widths[col.id] = Math.max(col.minWidth, Math.min(col.maxWidth, savedSettings.widths[col.id])); else if (!col.isWidthAdjustable) widths[col.id] = col.defaultWidth; }); return { visibility, widths }; } catch (e) { console.error("Failed to load column settings:", e); } } const initialVisibility = { ...defaultColumnVisibility }; const initialWidths = { ...defaultColumnWidths }; columnConfig.forEach(col => { if (!col.isVisibilityToggleable) initialVisibility[col.id] = true; if (!col.isWidthAdjustable) initialWidths[col.id] = col.defaultWidth; }); return { visibility: initialVisibility, widths: initialWidths };
    };
    const saveColumnSettings = (visibility, widths) => { /* ... Omitted for brevity ... */
        const settings = { visibility, widths }; localStorage.setItem(LS_KEYS.COLUMN_SETTINGS, JSON.stringify(settings));
    };

    // --- Components ---

    const Notification = memo(({ message, type, show }) => ( /* ... Omitted ... */
        <div className={`notification ${type} ${show ? 'show' : ''}`} role="alert">{message}</div>
    ));
    const SearchInput = memo(({ searchTerm, onSearchChange }) => ( /* ... Omitted ... */
        <div className="sidebar-section"><label htmlFor="search-input" className="settings-label" style={{textAlign: 'left', marginTop: 0}}>Поиск:</label><input type="search" id="search-input" className="search-input" placeholder="Название, Editor ID, ефект..." value={searchTerm} onChange={onSearchChange} aria-label="Поиск модулей" /></div>
    ));
    const FilterControls = memo(({ currentFilter, onFilterChange, onSidebarClose }) => ( /* ... Omitted ... */
        <div className="sidebar-section"><button className={`sidebar-button ${currentFilter === 'all' ? 'active' : ''}`} onClick={() => { onFilterChange('all'); onSidebarClose(); }}>Все Модули</button><button className={`sidebar-button ${currentFilter === 'learned' ? 'active' : ''}`} onClick={() => { onFilterChange('learned'); onSidebarClose(); }}>Изученные</button><button className={`sidebar-button ${currentFilter === 'notLearned' ? 'active' : ''}`} onClick={() => { onFilterChange('notLearned'); onSidebarClose(); }}>Не Изученные</button></div>
    ));
    const StatsDisplay = memo(({ stats }) => ( /* ... Omitted ... */
         <div className="stats-display">Всього: <strong>{stats.totalCount}</strong> | Вивчено: <strong>{stats.learnedCount}</strong> ({stats.percentage}%)</div>
    ));
    const SettingsSection = memo(({ columnConfig, columnVisibility, tempWidths, onVisibilityChange, onTempWidthChange, onResetSettings }) => ( /* Removed containerWidth */
         <div className="sidebar-section"><h3 className="settings-label" style={{textAlign: 'center', fontSize: '1em', marginBottom: '15px'}}>Настройки Таблицы</h3><h4 className="settings-label" style={{marginTop: '20px'}}>Видимость Колонок:</h4>{columnConfig.map(col => ( col.isVisibilityToggleable && ( <div key={`vis-toggle-${col.id}`} className="settings-control"><label htmlFor={`vis-${col.id}`}><input type="checkbox" id={`vis-${col.id}`} checked={columnVisibility[col.id]} onChange={() => onVisibilityChange(col.id)} />{col.label}</label></div> )))}<h4 className="settings-label" style={{marginTop: '20px'}}>Ширина Колонок:</h4>{columnConfig.map(col => ( columnVisibility[col.id] && col.isWidthAdjustable && ( <div key={`width-slider-${col.id}`} className="settings-control"><label htmlFor={`width-${col.id}`}>{col.label}: <span className="width-value">({tempWidths[col.id]}px)</span></label><input type="range" id={`width-${col.id}`} min={col.minWidth} max={col.maxWidth} value={tempWidths[col.id]} onChange={(e) => onTempWidthChange(col.id, e.target.value)} /></div> )))}<button className="sidebar-button reset-button" onClick={onResetSettings} style={{marginTop: '20px'}}>Сбросить настройки</button></div>
    ));
    const IOSection = memo(({ onImportClick, onExport }) => ( /* ... Omitted ... */
         <div className="sidebar-section"><h3 className="settings-label" style={{textAlign: 'center', fontSize: '1em', marginBottom: '15px'}}>Импорт / Экспорт</h3><button className="sidebar-button io-button" onClick={onImportClick} aria-label="Импортирую данные из файла">Импорт JSON</button><button className="sidebar-button io-button" onClick={onExport} aria-label="Экспортировать данные в файл">Экспорт JSON</button></div>
    ));

    // --- Scrollable Container Component ---
    const ScrollableContainer = ({ children, className = '', scrollDep = null }) => {
        const scrollRef = useRef(null);
        const [canScrollUp, setCanScrollUp] = useState(false);
        const [canScrollDown, setCanScrollDown] = useState(false);

        const checkScroll = useCallback(() => {
            const el = scrollRef.current;
            if (!el) return;
            const isScrollable = el.scrollHeight > el.clientHeight;
            setCanScrollUp(isScrollable && el.scrollTop > 0);
            setCanScrollDown(isScrollable && el.scrollTop < el.scrollHeight - el.clientHeight - 1); // -1 for precision
        }, []);

        useEffect(() => {
            const el = scrollRef.current;
            if (!el) return;
            checkScroll(); // Initial check

            // Check on resize and content changes (via scrollDep)
            const observer = new ResizeObserver(checkScroll);
            observer.observe(el);
            el.addEventListener('scroll', checkScroll);

            return () => {
                observer.unobserve(el);
                el.removeEventListener('scroll', checkScroll);
            };
        }, [checkScroll, scrollDep]); // Re-check when scrollDep changes

        const handleScroll = useCallback((direction) => {
            const el = scrollRef.current;
            if (!el) return;
            const amount = direction === 'up' ? -SCROLL_STEP : SCROLL_STEP;
            el.scrollBy({ top: amount, behavior: 'smooth' });
        }, []);

        return (
            <div ref={scrollRef} className={`${className} hide-scrollbar`} onScroll={checkScroll}>
                {children}
                <button
                    className={`scroll-arrow scroll-arrow-up ${!canScrollUp ? 'hidden' : ''}`}
                    onClick={() => handleScroll('up')}
                    aria-label="Прокрутити вгору"
                    disabled={!canScrollUp}
                >▲</button>
                <button
                    className={`scroll-arrow scroll-arrow-down ${!canScrollDown ? 'hidden' : ''}`}
                    onClick={() => handleScroll('down')}
                    aria-label="Прокрутити вниз"
                    disabled={!canScrollDown}
                >▼</button>
            </div>
        );
    };


    const Sidebar = memo(({
        isMobileOpen, isDesktopCollapsed, onMobileClose, onDesktopToggle,
        currentFilter, onFilterChange, stats, columnConfig, columnVisibility,
        tempWidths, onVisibilityChange, onTempWidthChange,
        onResetSettings, onImportClick, onExport, searchTerm, onSearchChange
     }) => ( // Removed containerWidth/onWidthChange
        <div className={`pipboy-sidebar ${isDesktopCollapsed ? 'sidebar-collapsed' : ''} ${isMobileOpen ? 'mobile-sidebar-open' : ''}`}>
             <button className="mobile-close-button" onClick={onMobileClose} aria-label="Закрити меню">×</button>
             {/* Desktop toggle button is now positioned relative to container */}
             <ScrollableContainer className="sidebar-content-wrapper" scrollDep={currentFilter}> {/* Pass dependencies that affect scroll height */}
                <h2>Меню</h2>
                <SearchInput searchTerm={searchTerm} onSearchChange={onSearchChange} />
                <FilterControls currentFilter={currentFilter} onFilterChange={onFilterChange} onSidebarClose={onMobileClose} />
                <StatsDisplay stats={stats} />
                <SettingsSection
                    columnConfig={columnConfig}
                    columnVisibility={columnVisibility}
                    tempWidths={tempWidths}
                    onVisibilityChange={onVisibilityChange}
                    onTempWidthChange={onTempWidthChange}
                    onResetSettings={onResetSettings}
                />
                 <IOSection onImportClick={onImportClick} onExport={onExport} />
             </ScrollableContainer>
        </div>
    ));

    const ModuleActions = memo(({ module, onEdit, onDelete }) => ( /* ... Omitted ... */
        <div className="module-actions"><button onClick={() => onEdit(module)} className="action-button edit-button" aria-label="Редагувати модуль">✏️</button><button onClick={() => onDelete(module.ruName, module.stars)} className="action-button delete-button" aria-label="Видалити модуль">🗑️</button></div>
    ));

    const ModuleTableRow = memo(({ module, columnVisibility, dataLabels, onLearnedChange, onEdit, onDelete, highlightTerm }) => ( /* Removed sortConfig */
         <tr key={`${module.ruName}-${module.stars}`}>
            {/* Desktop View Cells */}
            <td><input type="checkbox" className="learned-checkbox" checked={module.learned} onChange={() => onLearnedChange(module.ruName, module.stars)} aria-label={`Отметить ${module.ruName} как ${module.learned ? 'не изученный' : 'изученный'}`} /></td>
            {columnVisibility.ruName && <td>{highlightText(module.ruName, highlightTerm)}</td>}
            {columnVisibility.enName && <td>{highlightText(module.enName || '-', highlightTerm)}</td>}
            {columnVisibility.stars && <td>{getStars(module.stars)}</td>}
            {columnVisibility.effect && <td className="effect-cell">{highlightText(formatEffectText(module.effect), highlightTerm)}</td>}
            <td><ModuleActions module={module} onEdit={onEdit} onDelete={onDelete} /></td>

            {/* Mobile Card Structure (Shown via CSS) */}
            <div className="card-header">
                 <input type="checkbox" className="learned-checkbox" checked={module.learned} onChange={() => onLearnedChange(module.ruName, module.stars)} aria-label={`Отметить ${module.ruName} как ${module.learned ? 'не изученный' : 'изученный'}`} />
                 <ModuleActions module={module} onEdit={onEdit} onDelete={onDelete} />
            </div>
            <div className="card-body">
                {columnVisibility.ruName && <div className="data-row" data-label={dataLabels.ruName}><span>{highlightText(module.ruName, highlightTerm)}</span></div>}
                {columnVisibility.enName && <div className="data-row" data-label={dataLabels.enName}><span>{highlightText(module.enName || '-', highlightTerm)}</span></div>}
                {columnVisibility.stars && <div className="data-row" data-label={dataLabels.stars}><span>{getStars(module.stars)}</span></div>}
                {columnVisibility.effect && <div className="data-row" data-label={dataLabels.effect}><span className="effect-cell">{highlightText(formatEffectText(module.effect), highlightTerm)}</span></div>}
            </div>
        </tr>
    ));

    const ModuleTable = memo(({ modules, columnConfig, columnVisibility, columnWidths, sortConfig, onSort, dataLabels, onLearnedChange, onEdit, onDelete, highlightTerm }) => ( /* ... Omitted ... */
        <table className="module-table"><thead><tr>{columnConfig.map(col => ( columnVisibility[col.id] && ( <th key={col.id} className={col.isSortable ? 'sortable' : ''} style={{ width: col.isWidthAdjustable ? `${columnWidths[col.id]}px` : undefined }} onClick={col.isSortable ? () => onSort(col.id) : undefined} aria-label={col.isSortable ? `Сортувати за ${col.label}` : col.label}>{col.label}{col.isSortable && sortConfig.key === col.id && (<span className="sort-indicator">{sortConfig.direction === 'asc' ? '▲' : '▼'}</span>)}</th> )))}</tr></thead><tbody>{modules.length > 0 ? ( modules.map((module) => ( <ModuleTableRow key={`${module.ruName}-${module.stars}`} module={module} columnVisibility={columnVisibility} dataLabels={dataLabels} onLearnedChange={onLearnedChange} onEdit={onEdit} onDelete={onDelete} highlightTerm={highlightTerm} /> )) ) : ( <tr><td colSpan={columnConfig.filter(c => columnVisibility[c.id]).length} className="no-modules-message">{highlightTerm ? 'Модулів не знайдено за вашим запитом.' : 'Немає модулів для відображення за поточними фільтрами.'}</td></tr> )}</tbody></table>
    ));

    const ModuleForm = memo(({ formData, onChange, onSubmit, isEditMode = false, onCancelEdit = null, moduleBeingEdited = null }) => { /* ... Omitted ... */
        const isPredefined = isEditMode && moduleBeingEdited && !moduleBeingEdited.isCustom; return ( <form onSubmit={onSubmit} className="module-form"><div><label htmlFor={isEditMode ? "edit-ruName" : "add-ruName"}>Русское Название:</label><input type="text" id={isEditMode ? "edit-ruName" : "add-ruName"} name="ruName" value={formData.ruName} onChange={onChange} required disabled={isPredefined} aria-disabled={isPredefined} /></div><div><label htmlFor={isEditMode ? "edit-enName" : "add-enName"}>Editor ID:</label><input type="text" id={isEditMode ? "edit-enName" : "add-enName"} name="enName" value={formData.enName} onChange={onChange} /></div><div><label htmlFor={isEditMode ? "edit-stars" : "add-stars"}>Количество Звёзд:</label><select id={isEditMode ? "edit-stars" : "add-stars"} name="stars" value={formData.stars} onChange={onChange} required disabled={isPredefined} aria-disabled={isPredefined}><option value={1}>1</option><option value={2}>2</option><option value={3}>3</option><option value={4}>4</option></select></div><div style={{ gridColumn: '1 / -1' }}><label htmlFor={isEditMode ? "edit-effect" : "add-effect"}>Эффект:</label><input type="text" id={isEditMode ? "edit-effect" : "add-effect"} name="effect" value={formData.effect} onChange={onChange} required /></div><div className="module-form-buttons" style={{ gridColumn: '1 / -1' }}>{isEditMode && (<button type="button" onClick={onCancelEdit}>Скасувати</button>)}<button type="submit">{isEditMode ? 'Зберегти Зміни' : 'Додати Модуль'}</button></div></form> );
    });

    const EditModuleModal = memo(({ module, isOpen, onClose, onSave }) => { /* ... Omitted ... */
        const [formData, setFormData] = useState({ ruName: '', enName: '', stars: 1, effect: '' }); const [originalKey, setOriginalKey] = useState(''); useEffect(() => { if (module) { setFormData({ ruName: module.ruName || '', enName: module.enName || '', stars: module.stars || 1, effect: module.effect || '' }); setOriginalKey(`${module.ruName}-${module.stars}`); } else { setFormData({ ruName: '', enName: '', stars: 1, effect: '' }); setOriginalKey(''); } }, [module]); const handleChange = useCallback((e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); }, []); const handleSubmit = useCallback((e) => { e.preventDefault(); const starsInt = parseInt(formData.stars, 10); if (!formData.ruName || !starsInt || !formData.effect) { alert('Пожалуйста, заполните поля: Русское Название, Звёзды, Эффект.'); return; } onSave(originalKey, { ...formData, stars: starsInt, isCustom: true }); }, [formData, originalKey, onSave]); if (!isOpen) return null; return ( <div className={`modal-overlay ${isOpen ? 'active' : ''}`} onClick={onClose} role="dialog" aria-modal="true" aria-labelledby="edit-modal-title"><div className="modal-content" onClick={(e) => e.stopPropagation()}><div className="modal-header"><button className="modal-close-button" onClick={onClose} aria-label="Закрити модальне вікно">×</button><h3 id="edit-modal-title">Редагувати Модуль</h3></div><div className="modal-body"><ModuleForm formData={formData} onChange={handleChange} onSubmit={handleSubmit} isEditMode={true} onCancelEdit={onClose} moduleBeingEdited={module} /></div></div></div> );
    });


    // --- Main App Component ---
    function App() {
        const [modules, setModules] = useState(loadModules);
        const [filter, setFilter] = useState('all');
        // const [containerWidth, setContainerWidth] = useState(loadContainerWidth); // Removed
        const [columnSettings, setColumnSettings] = useState(loadColumnSettings);
        const { visibility: columnVisibility, widths: columnWidths } = columnSettings;
        const [sortConfig, setSortConfig] = useState({ key: 'stars', direction: 'asc' });
        const [addModuleFormData, setAddModuleFormData] = useState({ ruName: '', enName: '', stars: 1, effect: '' });
        const [isMobileSidebarOpen, setIsMobileSidebarOpen] = useState(false);
        const [isDesktopSidebarCollapsed, setIsDesktopSidebarCollapsed] = useState(false);
        const [tempWidths, setTempWidths] = useState(columnWidths);
        const [searchTerm, setSearchTerm] = useState('');
        const [isEditModalOpen, setIsEditModalOpen] = useState(false);
        const [moduleBeingEdited, setModuleBeingEdited] = useState(null);
        const [notification, showNotification, NotificationComponent] = useNotification();

        const debouncedWidths = useDebounce(tempWidths, DEBOUNCE_DELAY.WIDTH);
        const debouncedSearchTerm = useDebounce(searchTerm, DEBOUNCE_DELAY.SEARCH);
        const fileInputRef = useRef(null);

        // --- Effects ---
        useEffect(() => { saveModules(modules); }, [modules]);
        // useEffect(() => { saveContainerWidth(containerWidth); }, [containerWidth]); // Removed
        useEffect(() => { if (JSON.stringify(debouncedWidths) !== JSON.stringify(columnWidths)) { setColumnSettings(prev => ({ ...prev, widths: debouncedWidths })); saveColumnSettings(columnVisibility, debouncedWidths); } }, [debouncedWidths]); // Depends only on debounced value now
        useEffect(() => { setTempWidths(columnWidths); }, [columnWidths]);
        useEffect(() => { const handleResize = () => { if (window.innerWidth > 768) { if(isMobileSidebarOpen) setIsMobileSidebarOpen(false); } else { if(isDesktopSidebarCollapsed) setIsDesktopSidebarCollapsed(false); } }; window.addEventListener('resize', handleResize); handleResize(); return () => window.removeEventListener('resize', handleResize); }, [isMobileSidebarOpen, isDesktopSidebarCollapsed]);

        // --- Handlers ---
        const handleLearnedChange = useCallback((ruName, stars) => { setModules(prev => prev.map(m => m.ruName === ruName && m.stars === stars ? { ...m, learned: !m.learned } : m)); }, []);
        const handleAddFormChange = useCallback((e) => { const { name, value } = e.target; setAddModuleFormData(prev => ({ ...prev, [name]: value })); }, []);
        const handleAddModule = useCallback((e) => { /* ... Omitted - same as before, uses showNotification ... */
            e.preventDefault(); const { ruName, enName, stars, effect } = addModuleFormData; const starsInt = parseInt(stars, 10); if (!ruName || !starsInt || !effect) { showNotification('Пожалуйста, заполните поля: Русское Название, Звёзды, Эффект.', 'error'); return; } const moduleKey = `${ruName}-${starsInt}`; if (modules.some(m => `${m.ruName}-${m.stars}` === moduleKey)) { showNotification('Модуль с таким названием и количеством звезд уже существует!', 'error'); return; } setModules(prev => [...prev, { ruName, enName: enName || '', stars: starsInt, effect, learned: true, isCustom: true }]); setAddModuleFormData({ ruName: '', enName: '', stars: 1, effect: '' }); showNotification(`Модуль "${ruName}" успішно додано!`, 'success');
        }, [addModuleFormData, modules, showNotification]);
        const handleOpenEditModal = useCallback((module) => { setModuleBeingEdited(module); setIsEditModalOpen(true); }, []);
        const handleCloseEditModal = useCallback(() => { setIsEditModalOpen(false); setModuleBeingEdited(null); }, []);
        const handleSaveChangesInModal = useCallback((originalKey, updatedData) => { /* ... Omitted - same as before, uses showNotification ... */
             const newKey = `${updatedData.ruName}-${updatedData.stars}`; if (originalKey !== newKey && modules.some(m => `${m.ruName}-${m.stars}` === newKey)) { showNotification('Модуль с таким новым названием и количеством звезд уже существует!', 'error'); return; } setModules(prevModules => prevModules.map(m => `${m.ruName}-${m.stars}` === originalKey ? { ...m, ...updatedData } : m )); handleCloseEditModal(); showNotification(`Модуль "${updatedData.ruName}" успішно оновлено!`, 'success');
        }, [modules, handleCloseEditModal, showNotification]);
        const handleDeleteModule = useCallback((ruName, stars) => { if (window.confirm(`Вы уверены, что хотите удалить модуль "${ruName}" (${stars}⭐)?`)) { setModules(prev => prev.filter(m => !(m.ruName === ruName && m.stars === stars))); showNotification(`Модуль "${ruName}" удалено.`, 'success'); } }, [showNotification]);
        const handleVisibilityChange = useCallback((columnId) => { setColumnSettings(prev => { const newVisibility = { ...prev.visibility, [columnId]: !prev.visibility[columnId] }; saveColumnSettings(newVisibility, prev.widths); return { ...prev, visibility: newVisibility }; }); }, []);
        const handleTempWidthChange = useCallback((columnId, newWidth) => { setTempWidths(prev => ({ ...prev, [columnId]: parseInt(newWidth, 10) })); }, []);
        const handleSort = useCallback((columnId) => { setSortConfig(prev => ({ key: columnId, direction: prev.key === columnId && prev.direction === 'asc' ? 'desc' : 'asc' })); }, []);
        const toggleMobileSidebar = useCallback(() => setIsMobileSidebarOpen(prev => !prev), []);
        const toggleDesktopSidebar = useCallback(() => setIsDesktopSidebarCollapsed(prev => !prev), []);
        const handleResetSettings = useCallback(() => { const defaultVis = defaultColumnVisibility; const defaultW = defaultColumnWidths; setColumnSettings({ visibility: defaultVis, widths: defaultW }); setTempWidths(defaultW); saveColumnSettings(defaultVis, defaultW); if(isMobileSidebarOpen) setIsMobileSidebarOpen(false); showNotification('Настройки таблицы скинуто.', 'success'); }, [isMobileSidebarOpen, showNotification]);
        const handleSearchChange = useCallback((e) => { setSearchTerm(e.target.value); }, []);
        const handleExport = useCallback(() => { /* ... Omitted - same as before, uses showNotification ... */
            try { const dataToExport = { modules: modules.map(({ ruName, stars, learned, enName, effect, isCustom }) => ({ ruName, stars, learned, enName, effect, isCustom })), columnSettings: { visibility: columnVisibility, widths: columnWidths }, }; const jsonString = JSON.stringify(dataToExport, null, 2); const blob = new Blob([jsonString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `fallout76_modules_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showNotification('Данные успешно экспортировано!', 'success'); } catch (error) { console.error("Export failed:", error); showNotification('Ошибка экспорта данных.', 'error'); }
        }, [modules, columnVisibility, columnWidths, showNotification]);
        const handleImportClick = useCallback(() => { fileInputRef.current?.click(); }, []);
        const handleImportFile = useCallback((event) => { /* ... Omitted - same validation and processing, uses showNotification ... */
            const file = event.target.files?.[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const importedData = JSON.parse(e.target.result); if (!importedData || typeof importedData !== 'object') throw new Error("Invalid file format."); if (!Array.isArray(importedData.modules)) throw new Error("Missing or invalid 'modules' data."); if (typeof importedData.columnSettings?.visibility !== 'object' || typeof importedData.columnSettings?.widths !== 'object') throw new Error("Missing or invalid 'columnSettings' data."); if (window.confirm('Импортировать данные? Текущие данные будут перезаписано!')) { let importedModules = []; const initialMap = new Map(initialModulesData.map(m => [`${m.ruName}-${m.stars}`, { ...m, isCustom: false }])); const importedMap = new Map(); importedData.modules.forEach(m => { if(m && m.ruName && m.stars) importedMap.set(`${m.ruName}-${m.stars}`, m) }); initialMap.forEach((initialModule, key) => { const imported = importedMap.get(key); if (imported) { importedModules.push({ ...initialModule, learned: !!imported.learned, isCustom: imported.isCustom ?? false }); importedMap.delete(key); } else { importedModules.push({ ...initialModule, learned: false }); } }); importedMap.forEach(custom => { importedModules.push({ ruName: custom.ruName, enName: custom.enName || '', stars: custom.stars, effect: custom.effect || '', learned: !!custom.learned, isCustom: true }); }); setModules(importedModules); const newVisibility = { ...defaultColumnVisibility }; const newWidths = { ...defaultColumnWidths }; columnConfig.forEach(col => { if (col.isVisibilityToggleable && typeof importedData.columnSettings.visibility?.[col.id] === 'boolean') newVisibility[col.id] = importedData.columnSettings.visibility[col.id]; if (col.isWidthAdjustable && typeof importedData.columnSettings.widths?.[col.id] === 'number') newWidths[col.id] = Math.max(col.minWidth, Math.min(col.maxWidth, importedData.columnSettings.widths[col.id])); }); setColumnSettings({ visibility: newVisibility, widths: newWidths }); setTempWidths(newWidths); showNotification('Дані успішно импортировано!', 'success'); } } catch (error) { console.error("Import failed:", error); showNotification(`Ошибка импорта: ${error.message}`, 'error'); } finally { if (fileInputRef.current) fileInputRef.current.value = ''; } }; reader.onerror = () => { showNotification('Не удалось считать файл.', 'error'); if (fileInputRef.current) fileInputRef.current.value = ''; }; reader.readAsText(file);
        }, [showNotification]);

        // --- Memoized Filtered and Sorted Modules ---
        const processedModules = useMemo(() => { /* ... Omitted for brevity - same as before ... */
            const searchTermLower = debouncedSearchTerm.toLowerCase(); const searched = !searchTermLower ? modules : modules.filter(m => m.ruName.toLowerCase().includes(searchTermLower) || (m.enName && m.enName.toLowerCase().includes(searchTermLower)) || (m.effect && m.effect.toLowerCase().includes(searchTermLower)) ); let filtered = []; switch (filter) { case 'learned': filtered = searched.filter(m => m.learned); break; case 'notLearned': filtered = searched.filter(m => !m.learned); break; default: filtered = searched; break; } const { key: sortKey, direction: sortDirection } = sortConfig; const sortMultiplier = sortDirection === 'asc' ? 1 : -1; const columnType = columnConfig.find(c => c.id === sortKey)?.type || 'string'; filtered.sort((a, b) => { let valA = a[sortKey]; let valB = b[sortKey]; if (columnType === 'string') { valA = String(valA ?? ''); valB = String(valB ?? ''); const comp = valA.localeCompare(valB, 'ru', { sensitivity: 'base' }); if (comp !== 0) return comp * sortMultiplier; } else if (columnType === 'number') { valA = Number(valA ?? 0); valB = Number(valB ?? 0); if (valA !== valB) return (valA - valB) * sortMultiplier; } else if (columnType === 'boolean') { valA = Boolean(valA); valB = Boolean(valB); if (valA !== valB) return (valA - valB) * sortMultiplier; } return a.ruName.localeCompare(b.ruName, 'ru', { sensitivity: 'base' }); }); return filtered;
        }, [modules, filter, sortConfig, debouncedSearchTerm]);

        // Create data labels for mobile view
        const dataLabels = useMemo(() => { return columnConfig.reduce((acc, col) => { acc[col.id] = col.label; return acc; }, {}); }, []);

        // Calculate Stats
        const stats = useMemo(() => { const totalCount = modules.length; const learnedCount = modules.filter(m => m.learned).length; const percentage = totalCount > 0 ? ((learnedCount / totalCount) * 100).toFixed(1) : 0; return { totalCount, learnedCount, percentage }; }, [modules]);


        return (
            <Fragment>
                <button id="mobile-settings-button" onClick={toggleMobileSidebar} aria-label="Открыть настройки">⚙️</button>
                <div id="sidebar-overlay" className={isMobileSidebarOpen ? 'active' : ''} onClick={toggleMobileSidebar}></div>
                <input type="file" id="file-import-input" ref={fileInputRef} onChange={handleImportFile} accept=".json" />

                <div className="pipboy-container"> {/* Removed width style */}
                    <Sidebar
                        isMobileOpen={isMobileSidebarOpen}
                        isDesktopCollapsed={isDesktopSidebarCollapsed}
                        onMobileClose={toggleMobileSidebar}
                        onDesktopToggle={toggleDesktopSidebar}
                        currentFilter={filter}
                        onFilterChange={setFilter}
                        stats={stats}
                        columnConfig={columnConfig}
                        columnVisibility={columnVisibility}
                        tempWidths={tempWidths}
                        // containerWidth={containerWidth} // Removed
                        onVisibilityChange={handleVisibilityChange}
                        onTempWidthChange={handleTempWidthChange}
                        // onWidthChange={setContainerWidth} // Removed
                        onResetSettings={handleResetSettings}
                        onImportClick={handleImportClick}
                        onExport={handleExport}
                        searchTerm={searchTerm}
                        onSearchChange={handleSearchChange}
                    />
                     {/* Desktop Collapse Toggle Button - Moved outside sidebar div */}
                     <button id="desktop-sidebar-toggle" onClick={toggleDesktopSidebar} aria-label={isDesktopSidebarCollapsed ? "Розгорнути бічну панель" : "Згорнути бічну панель"}>
                         {isDesktopSidebarCollapsed ? '»' : '«'}
                     </button>

                    {/* Main Content */}
                    <div className="pipboy-content">
                         <ScrollableContainer className="pipboy-content-wrapper hide-scrollbar" scrollDep={processedModules}> {/* Wrap content */}
                            <div className="pipboy-header">Менеджер Легендарних Модулей</div>
                            <ModuleTable
                                 modules={processedModules}
                                 columnConfig={columnConfig}
                                 columnVisibility={columnVisibility}
                                 columnWidths={columnWidths}
                                 sortConfig={sortConfig}
                                 onSort={handleSort}
                                 dataLabels={dataLabels}
                                 onLearnedChange={handleLearnedChange}
                                 onEdit={handleOpenEditModal}
                                 onDelete={handleDeleteModule}
                                 highlightTerm={debouncedSearchTerm}
                             />
                            {/* Add Module Section (Only for Adding) */}
                            <div id="module-form-section" className="module-form-section">
                                <h3>Добавить Новый Модуль</h3>
                                 <ModuleForm
                                     formData={addModuleFormData}
                                     onChange={handleAddFormChange}
                                     onSubmit={handleAddModule}
                                     isEditMode={false}
                                 />
                            </div>
                        </ScrollableContainer>
                    </div>
                </div>

                 {/* Edit Modal */}
                 <EditModuleModal
                     isOpen={isEditModalOpen}
                     module={moduleBeingEdited}
                     onClose={handleCloseEditModal}
                     onSave={handleSaveChangesInModal}
                 />
                 {/* Notification Area */}
                 <NotificationComponent {...notification} />
            </Fragment>
        );
    }

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
</script>

</body>
</html>